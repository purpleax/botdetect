import { CoreModule } from './modules/core.js';
import { ClientInfoModule } from './modules/clientInfo.js';
import { BotDetectionModule } from './modules/botDetection.js';
import { ChallengeModule } from './modules/challenge.js';
import { UIModule } from './modules/ui.js';

const BotDetector = (function() {
    let core, clientInfo, botDetection, challenge, ui;

    function init(config) {
        core = new CoreModule(config);
        clientInfo = new ClientInfoModule();
        botDetection = new BotDetectionModule(core.getWeights(), core.getConfig());
        challenge = new ChallengeModule(core.getConfig());
        ui = new UIModule();

        runDetection();
    }

    function runDetection() {
        const info = clientInfo.collect();
        ui.displayInfo(info);

        const checks = botDetection.performChecks(info);
        ui.updateBotChecks(checks);

        if (botDetection.isSuspicious(checks)) {
            challenge.runPoW().then(powSuccess => {
                if (!powSuccess) {
                    challenge.runCaptcha();
                }
            });
        } else {
            core.setDetectionResult('passed');
        }

        if (core.getConfig().debug) {
            console.log('Debug Mode: ON');
            console.log('Client Info:', info);
            console.log('Bot Checks:', checks);
            console.log('Detection Result:', core.getDetectionResult());
        }
    }

    return {
        init: init,
        getDetectionResult: () => core.getDetectionResult(),
        setDebugMode: (debug, forceFail) => {
            core.setDebugMode(debug, forceFail);
            console.log(`Debug Mode: ${debug ? 'ON' : 'OFF'}, Force Fail: ${forceFail ? 'ON' : 'OFF'}`);
            runDetection();
        }
    };
})();

export default BotDetector;
